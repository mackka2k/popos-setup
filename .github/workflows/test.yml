name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck setup.sh lib/*.sh || true
          echo "ShellCheck completed"
  
  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check bash syntax
        run: |
          bash -n setup.sh
          for file in lib/*.sh; do
            bash -n "$file"
          done
          echo "âœ“ All files have valid bash syntax"
  
  unit-tests:
    name: BATS Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install BATS
        run: |
          sudo apt-get update
          sudo apt-get install -y bats
      
      - name: Run unit tests
        run: |
          cd test
          bats unit/*.bats
  
  integration-tests:
    name: Docker Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Run Ubuntu integration test
        run: |
          cd test/integration
          docker-compose run --rm ubuntu-test
      
      - name: Run Pop!_OS integration test
        run: |
          cd test/integration
          docker-compose run --rm popos-test
      
      - name: Cleanup
        if: always()
        run: |
          cd test/integration
          docker-compose down
  
  dry-run-test:
    name: Dry Run Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run dry-run mode
        run: |
          sudo bash setup.sh --dry-run --yes || true
          echo "Dry-run test completed"
